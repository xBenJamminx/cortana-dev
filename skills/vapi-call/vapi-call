#!/bin/bash
# VAPI Outbound Call Skill

set -e

source /root/.openclaw/.env
VAPI_API_KEY="${VAPI_API_KEY:?VAPI_API_KEY not set}"
ASSISTANT_ID="899db371-3ca9-44f6-8ad3-a70131af4987"
PHONE_NUMBER_ID="3d76fe66-e37e-4c9c-af92-695690631c9b"

usage() {
    echo "Usage: vapi-call <phone_number> [message]"
    echo ""
    echo "Arguments:"
    echo "  phone_number    Phone number to call (with country code, e.g. +15551234567)"
    echo "  message         Optional custom greeting message"
    exit 1
}

if [ -z "$1" ]; then
    usage
fi

PHONE="$1"
MESSAGE="$2"

# Build JSON payload
if [ -n "$MESSAGE" ]; then
    PAYLOAD=$(cat <<JSON
{
  "assistantId": "$ASSISTANT_ID",
  "phoneNumberId": "$PHONE_NUMBER_ID",
  "customer": {"number": "$PHONE"},
  "assistantOverrides": {"firstMessage": "$MESSAGE"}
}
JSON
)
else
    PAYLOAD=$(cat <<JSON
{
  "assistantId": "$ASSISTANT_ID",
  "phoneNumberId": "$PHONE_NUMBER_ID",
  "customer": {"number": "$PHONE"}
}
JSON
)
fi

# Make the call
RESPONSE=$(curl -s -X POST "https://api.vapi.ai/call" \
  -H "Authorization: Bearer $VAPI_API_KEY" \
  -H "Content-Type: application/json" \
  -d "$PAYLOAD")

# Check result
if echo "$RESPONSE" | grep -q id; then
    CALL_ID=$(echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin).get(id,))")
    echo "ðŸ“ž Calling $PHONE..."
    echo "Call ID: $CALL_ID"
else
    echo "âŒ Call failed:"
    echo "$RESPONSE"
    exit 1
fi
