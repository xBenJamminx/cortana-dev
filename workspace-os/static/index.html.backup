<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workspace OS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent: #58a6ff;
            --accent-hover: #79b8ff;
            --success: #3fb950;
            --warning: #d29922;
            --danger: #f85149;
            --purple: #a371f7;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 20px; background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color); height: 60px;
        }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .header-title { font-size: 20px; font-weight: 600; color: var(--accent); }
        .search-box {
            display: flex; align-items: center; background: var(--bg-tertiary);
            border: 1px solid var(--border-color); border-radius: 6px; padding: 6px 12px;
        }
        .search-box input {
            background: transparent; border: none; color: var(--text-primary);
            outline: none; width: 250px; font-size: 14px;
        }
        .search-box input::placeholder { color: var(--text-secondary); }
        .header-right { display: flex; align-items: center; gap: 16px; }
        .connection-status { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--danger); }
        .status-dot.connected { background: var(--success); }
        .sync-btn {
            background: var(--accent); color: #fff; border: none; padding: 8px 16px;
            border-radius: 6px; cursor: pointer; font-size: 14px; transition: background 0.2s;
        }
        .sync-btn:hover { background: var(--accent-hover); }
        .sync-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar {
            width: 250px; background: var(--bg-secondary); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .sidebar-section { padding: 12px; border-bottom: 1px solid var(--border-color); }
        .sidebar-title { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; }
        .file-tree { flex: 1; overflow-y: auto; padding: 8px; }
        .tree-item { padding: 6px 8px; cursor: pointer; border-radius: 4px; font-size: 13px; display: flex; align-items: center; gap: 6px; }
        .tree-item:hover { background: var(--bg-tertiary); }
        .tree-icon { width: 16px; height: 16px; flex-shrink: 0; }
        .tree-children { margin-left: 16px; display: none; }
        .tree-children.expanded { display: block; }
        .quick-actions { display: flex; flex-direction: column; gap: 4px; }
        .quick-action {
            background: var(--bg-tertiary); border: 1px solid var(--border-color);
            color: var(--text-primary); padding: 8px 12px; border-radius: 4px;
            cursor: pointer; font-size: 13px; text-align: left; transition: all 0.2s;
        }
        .quick-action:hover { border-color: var(--accent); color: var(--accent); }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .tab-bar {
            display: flex; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);
            padding: 0 16px; gap: 4px;
        }
        .tab {
            padding: 12px 16px; cursor: pointer; font-size: 14px; color: var(--text-secondary);
            border-bottom: 2px solid transparent; transition: all 0.2s;
        }
        .tab:hover { color: var(--text-primary); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .content-area { flex: 1; overflow-y: auto; padding: 20px; }
        .right-panel {
            width: 300px; background: var(--bg-secondary); border-left: 1px solid var(--border-color);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .panel-header {
            padding: 16px; border-bottom: 1px solid var(--border-color);
            font-weight: 600; display: flex; justify-content: space-between; align-items: center;
        }
        .panel-content { flex: 1; overflow-y: auto; padding: 16px; }
        .panel-close { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 18px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; }
        .stat-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; }
        .stat-value { font-size: 32px; font-weight: 600; color: var(--text-primary); }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .dashboard-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; }
        .card-title { font-size: 14px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary); }
        .activity-list { display: flex; flex-direction: column; gap: 12px; max-height: 300px; overflow-y: auto; }
        .activity-item { display: flex; gap: 12px; font-size: 13px; }
        .activity-icon { width: 32px; height: 32px; border-radius: 50%; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .activity-content { flex: 1; }
        .activity-time { color: var(--text-secondary); font-size: 11px; }
        .integration-list { display: flex; flex-direction: column; gap: 8px; }
        .integration-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg-tertiary); border-radius: 4px; }
        .integration-status { display: flex; align-items: center; gap: 6px; font-size: 12px; }
        .integration-status.active { color: var(--success); }
        .integration-status.inactive { color: var(--text-secondary); }
        .kanban-board { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 16px; min-height: 500px; }
        .kanban-column { min-width: 280px; max-width: 280px; background: var(--bg-secondary); border-radius: 8px; display: flex; flex-direction: column; }
        .kanban-header { padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .kanban-title { font-weight: 600; font-size: 14px; }
        .kanban-count { background: var(--bg-tertiary); padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        .kanban-cards { flex: 1; padding: 12px; overflow-y: auto; min-height: 200px; }
        .kanban-cards.drag-over { background: var(--bg-tertiary); border-radius: 4px; }
        .kanban-card { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; margin-bottom: 8px; cursor: grab; transition: all 0.2s; }
        .kanban-card:hover { border-color: var(--accent); }
        .kanban-card.dragging { opacity: 0.5; }
        .kanban-card-title { font-size: 14px; font-weight: 500; margin-bottom: 8px; }
        .kanban-card-meta { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); }
        .add-card-btn { width: 100%; padding: 8px; background: transparent; border: 1px dashed var(--border-color); color: var(--text-secondary); border-radius: 4px; cursor: pointer; margin-top: 8px; }
        .add-card-btn:hover { border-color: var(--accent); color: var(--accent); }
        .ideas-list { display: flex; flex-direction: column; gap: 12px; }
        .idea-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s; }
        .idea-card:hover { border-color: var(--accent); }
        .idea-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .idea-title { font-weight: 500; }
        .priority-badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .priority-badge.hot { background: var(--danger); color: #fff; }
        .priority-badge.save { background: var(--warning); color: #000; }
        .priority-badge.maybe { background: var(--bg-tertiary); color: var(--text-secondary); }
        .idea-source { font-size: 12px; color: var(--text-secondary); }
        .idea-description { font-size: 13px; color: var(--text-secondary); margin-top: 8px; }
        .projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .project-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s; }
        .project-card:hover { border-color: var(--accent); }
        .project-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .project-title { font-weight: 600; font-size: 16px; }
        .project-status { padding: 4px 8px; border-radius: 4px; font-size: 11px; background: var(--bg-tertiary); }
        .project-status.active { background: var(--success); color: #000; }
        .project-status.paused { background: var(--warning); color: #000; }
        .project-status.completed { background: var(--purple); color: #fff; }
        .project-progress { margin: 12px 0; }
        .progress-bar { height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); transition: width 0.3s; }
        .progress-text { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        .task-list { margin-top: 12px; }
        .task-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 13px; }
        .task-checkbox { width: 16px; height: 16px; border: 1px solid var(--border-color); border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .task-checkbox.done { background: var(--success); border-color: var(--success); }
        .task-checkbox.done::after { content: '\2713'; color: #000; font-size: 12px; }
        .ai-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-container { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; }
        .chart-container canvas { max-height: 250px; }
        .ai-logs { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; }
        .ai-logs-header { padding: 16px; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .ai-logs-list { max-height: 400px; overflow-y: auto; }
        .ai-log-item { padding: 12px 16px; border-bottom: 1px solid var(--border-color); font-size: 13px; }
        .ai-log-item:last-child { border-bottom: none; }
        .ai-log-model { color: var(--purple); font-weight: 500; }
        .ai-log-prompt { color: var(--text-secondary); margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ai-log-meta { display: flex; gap: 16px; margin-top: 8px; font-size: 11px; color: var(--text-secondary); }
        .perf-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .perf-stat { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; text-align: center; }
        .perf-stat-value { font-size: 28px; font-weight: 600; }
        .perf-stat-label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        .perf-logs { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; }
        .perf-logs-header { padding: 16px; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .perf-log-item { padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .perf-grade { font-weight: 600; padding: 4px 12px; border-radius: 4px; }
        .perf-grade.a { background: var(--success); color: #000; }
        .perf-grade.b { background: #7ee787; color: #000; }
        .perf-grade.c { background: var(--warning); color: #000; }
        .perf-grade.d { background: #ffa657; color: #000; }
        .perf-grade.f { background: var(--danger); color: #fff; }
        .memory-layout { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        .memory-sidebar { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; }
        .memory-tabs { display: flex; border-bottom: 1px solid var(--border-color); }
        .memory-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-size: 13px; color: var(--text-secondary); border-bottom: 2px solid transparent; }
        .memory-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .memory-search { padding: 12px; border-bottom: 1px solid var(--border-color); }
        .memory-search input { width: 100%; padding: 8px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 13px; outline: none; }
        .memory-search input:focus { border-color: var(--accent); }
        .memory-list { max-height: 500px; overflow-y: auto; }
        .memory-item { padding: 12px 16px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .memory-item:hover { background: var(--bg-tertiary); }
        .memory-item.active { background: var(--bg-tertiary); border-left: 3px solid var(--accent); }
        .memory-date { font-size: 12px; color: var(--accent); font-weight: 500; }
        .memory-preview { font-size: 13px; color: var(--text-secondary); margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .memory-viewer { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; }
        .memory-content { white-space: pre-wrap; font-size: 14px; line-height: 1.6; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; width: 500px; max-width: 90vw; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-weight: 600; font-size: 16px; }
        .modal-close { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 20px; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 10px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px; }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--accent); }
        .form-textarea { min-height: 100px; resize: vertical; font-family: inherit; }
        .btn { padding: 10px 20px; border-radius: 6px; font-size: 14px; cursor: pointer; border: 1px solid var(--border-color); transition: all 0.2s; }
        .btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { border-color: var(--accent); }
        .btn-danger { background: var(--danger); border-color: var(--danger); color: #fff; }
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 12px 20px; border-radius: 6px; font-size: 14px; animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .toast.success { background: var(--success); color: #000; }
        .toast.error { background: var(--danger); color: #fff; }
        .toast.info { background: var(--accent); color: #fff; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; }
        .spinner { width: 32px; height: 32px; border: 3px solid var(--border-color); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
        .empty-state-text { font-size: 14px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
        @media (max-width: 1200px) {
            .right-panel { display: none; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .ai-grid { grid-template-columns: 1fr; }
            .memory-layout { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .search-box input { width: 150px; }
            .perf-stats { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-left">
                <div class="header-title">Workspace OS</div>
                <div class="search-box">
                    <input type="text" placeholder="Search... (Ctrl+K)" id="globalSearch">
                </div>
            </div>
            <div class="header-right">
                <div class="connection-status">
                    <span class="status-dot" id="wsStatus"></span>
                    <span id="wsStatusText">Disconnected</span>
                </div>
                <button class="sync-btn" id="syncBtn">Sync</button>
            </div>
        </header>
        <div class="main-layout">
            <aside class="sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title">Quick Actions</div>
                    <div class="quick-actions">
                        <button class="quick-action" id="newContentBtn">+ New Content</button>
                        <button class="quick-action" id="newIdeaBtn">+ New Idea</button>
                        <button class="quick-action" id="newProjectBtn">+ New Project</button>
                    </div>
                </div>
                <div class="sidebar-section" style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
                    <div class="sidebar-title">Files</div>
                    <div class="file-tree" id="fileTree">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </aside>
            <main class="main-content">
                <div class="tab-bar">
                    <div class="tab active" data-tab="dashboard">Dashboard</div>
                    <div class="tab" data-tab="content">Content</div>
                    <div class="tab" data-tab="ideas">Ideas</div>
                    <div class="tab" data-tab="projects">Projects</div>
                    <div class="tab" data-tab="ai">AI</div>
                    <div class="tab" data-tab="performance">Performance</div>
                    <div class="tab" data-tab="memory">Memory</div>
                </div>
                <div class="content-area" id="contentArea">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </main>
            <aside class="right-panel" id="rightPanel">
                <div class="panel-header">
                    <span id="panelTitle">Details</span>
                    <button class="panel-close" id="panelClose">&times;</button>
                </div>
                <div class="panel-content" id="panelContent">
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128203;</div>
                        <div class="empty-state-text">Select an item to view details</div>
                    </div>
                </div>
            </aside>
        </div>
    </div>
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Create New</span>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="modalCancel">Cancel</button>
                <button class="btn btn-primary" id="modalSubmit">Save</button>
            </div>
        </div>
    </div>
    <div class="toast-container" id="toastContainer"></div>
    <script>
    (function() {
        'use strict';

        var app = {
            currentTab: 'dashboard',
            ws: null,
            charts: {},
            data: { ideas: [], memories: [], projects: [] },
            selectedItem: null,
            editingId: null
        };

        // Initialize
        function init() {
            setupTabs();
            setupWebSocket();
            setupKeyboardShortcuts();
            setupEventListeners();
            loadFileTree();
            loadTab('dashboard');
        }

        // Event Listeners
        function setupEventListeners() {
            document.getElementById('syncBtn').addEventListener('click', triggerSync);
            document.getElementById('newContentBtn').addEventListener('click', function() { showModal('content'); });
            document.getElementById('newIdeaBtn').addEventListener('click', function() { showModal('idea'); });
            document.getElementById('newProjectBtn').addEventListener('click', function() { showModal('project'); });
            document.getElementById('modalClose').addEventListener('click', closeModal);
            document.getElementById('modalCancel').addEventListener('click', closeModal);
            document.getElementById('panelClose').addEventListener('click', closePanel);
            document.getElementById('modalOverlay').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
        }

        // Tab Management
        function setupTabs() {
            var tabs = document.querySelectorAll('.tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].addEventListener('click', function() {
                    var allTabs = document.querySelectorAll('.tab');
                    for (var j = 0; j < allTabs.length; j++) {
                        allTabs[j].classList.remove('active');
                    }
                    this.classList.add('active');
                    loadTab(this.dataset.tab);
                });
            }
        }

        function loadTab(tab) {
            app.currentTab = tab;
            var area = document.getElementById('contentArea');
            area.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            switch(tab) {
                case 'dashboard': renderDashboard(); break;
                case 'content': renderContent(); break;
                case 'ideas': renderIdeas(); break;
                case 'projects': renderProjects(); break;
                case 'ai': renderAI(); break;
                case 'performance': renderPerformance(); break;
                case 'memory': renderMemory(); break;
            }
        }

        // WebSocket
        function setupWebSocket() {
            var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            var wsUrl = protocol + '//' + window.location.host + '/ws';
            connectWebSocket(wsUrl);
        }

        function connectWebSocket(url) {
            try {
                app.ws = new WebSocket(url);

                app.ws.onopen = function() {
                    document.getElementById('wsStatus').classList.add('connected');
                    document.getElementById('wsStatusText').textContent = 'Connected';
                    toast('Connected to server', 'success');
                };

                app.ws.onclose = function() {
                    document.getElementById('wsStatus').classList.remove('connected');
                    document.getElementById('wsStatusText').textContent = 'Disconnected';
                    setTimeout(function() { connectWebSocket(url); }, 5000);
                };

                app.ws.onmessage = function(e) {
                    try {
                        var data = JSON.parse(e.data);
                        handleWsMessage(data);
                    } catch(err) {
                        console.error('WS message parse error:', err);
                    }
                };

                app.ws.onerror = function() {
                    document.getElementById('wsStatus').classList.remove('connected');
                    document.getElementById('wsStatusText').textContent = 'Error';
                };
            } catch(e) {
                console.error('WebSocket error:', e);
            }
        }

        function handleWsMessage(data) {
            if (data.type === 'update') {
                loadTab(app.currentTab);
                toast('Data updated', 'info');
            } else if (data.type === 'sync_complete') {
                toast('Sync completed', 'success');
                document.getElementById('syncBtn').disabled = false;
                document.getElementById('syncBtn').textContent = 'Sync';
                loadTab(app.currentTab);
            }
        }

        // Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('globalSearch').focus();
                }
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    var submitBtn = document.getElementById('modalSubmit');
                    if (submitBtn && document.getElementById('modalOverlay').classList.contains('active')) {
                        submitBtn.click();
                    }
                }
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
        }

        // API Helper
        function api(endpoint, options, callback) {
            options = options || {};
            var fetchOptions = {
                method: options.method || 'GET',
                headers: { 'Content-Type': 'application/json' }
            };
            if (options.body) {
                fetchOptions.body = JSON.stringify(options.body);
            }

            fetch('/api' + endpoint, fetchOptions)
                .then(function(res) {
                    if (!res.ok) throw new Error('API Error: ' + res.status);
                    return res.json();
                })
                .then(function(data) {
                    if (callback) callback(null, data);
                })
                .catch(function(err) {
                    console.error('API Error:', err);
                    if (callback) callback(err, null);
                });
        }

        // Toast
        function toast(message, type) {
            type = type || 'info';
            var container = document.getElementById('toastContainer');
            var toastEl = document.createElement('div');
            toastEl.className = 'toast ' + type;
            toastEl.textContent = message;
            container.appendChild(toastEl);
            setTimeout(function() { toastEl.remove(); }, 3000);
        }

        // File Tree
        function loadFileTree() {
            api('/files/tree', {}, function(err, data) {
                var tree = document.getElementById('fileTree');
                if (err || !data) {
                    tree.innerHTML = '<div class="empty-state"><div class="empty-state-text">Failed to load files</div></div>';
                    return;
                }
                tree.innerHTML = renderTree(data.items || data || []);
            });
        }

        function renderTree(items) {
            if (!items || !items.length) return '<div class="empty-state"><div class="empty-state-text">No files</div></div>';
            var html = '';
            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                var isFolder = item.type === 'directory' || item.is_dir;
                var icon = isFolder ? '&#128193;' : '&#128196;';
                var escapedPath = escapeAttr(item.path);
                html += '<div class="tree-item" data-path="' + escapedPath + '" data-folder="' + isFolder + '">';
                html += '<span class="tree-icon">' + icon + '</span>';
                html += '<span>' + escapeHtml(item.name) + '</span></div>';
                if (isFolder && item.children && item.children.length) {
                    html += '<div class="tree-children">' + renderTree(item.children) + '</div>';
                }
            }
            return html;
        }

        document.getElementById('fileTree').addEventListener('click', function(e) {
            var item = e.target.closest('.tree-item');
            if (!item) return;
            var path = item.dataset.path;
            var isFolder = item.dataset.folder === 'true';
            if (isFolder) {
                var children = item.nextElementSibling;
                if (children && children.classList.contains('tree-children')) {
                    children.classList.toggle('expanded');
                }
            } else {
                selectFile(path);
            }
        });

        function selectFile(path) {
            api('/files/read?path=' + encodeURIComponent(path), {}, function(err, data) {
                if (err) {
                    toast('Failed to load file', 'error');
                    return;
                }
                showPanel('File Preview', '<div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;">' + escapeHtml(path) + '</div><pre style="white-space:pre-wrap;font-size:12px;background:var(--bg-tertiary);padding:12px;border-radius:6px;max-height:calc(100vh - 200px);overflow:auto;">' + escapeHtml(data.content || '') + '</pre>');
            });
        }

        // Dashboard
        function renderDashboard() {
            var area = document.getElementById('contentArea');
            area.innerHTML = '<div class="stats-grid" id="dashStats"></div><div class="dashboard-grid" id="dashGrid"></div>';

            api('/dashboard/stats', {}, function(err, stats) {
                stats = stats || {};
                document.getElementById('dashStats').innerHTML =
                    '<div class="stat-card"><div class="stat-label">Projects</div><div class="stat-value">' + (stats.projects || stats.total_projects || 0) + '</div></div>' +
                    '<div class="stat-card"><div class="stat-label">Content Items</div><div class="stat-value">' + (stats.content || stats.content_items || 0) + '</div></div>' +
                    '<div class="stat-card"><div class="stat-label">Ideas</div><div class="stat-value">' + (stats.ideas || 0) + '</div></div>' +
                    '<div class="stat-card"><div class="stat-label">AI Costs (30d)</div><div class="stat-value">$' + (stats.ai_costs || (stats.costs && stats.costs.monthly) || 0).toFixed(2) + '</div></div>';
            });

            api('/dashboard/activity', {}, function(err, activity) {
                activity = activity || [];
                var activityHtml = activity.length ? activity.slice(0, 10).map(function(a) {
                    return '<div class="activity-item"><div class="activity-icon">' + getActivityIcon(a.type) + '</div><div class="activity-content"><div>' + escapeHtml(a.description || a.title || a.action || '') + '</div><div class="activity-time">' + formatTime(a.timestamp || a.created_at) + '</div></div></div>';
                }).join('') : '<div class="empty-state"><div class="empty-state-text">No recent activity</div></div>';

                api('/integrations/', {}, function(err2, integrations) {
                    integrations = integrations || [];
                    var integrationsHtml = integrations.length ? integrations.map(function(i) {
                        return '<div class="integration-item"><span>' + escapeHtml(i.name) + '</span><span class="integration-status ' + (i.status === 'active' ? 'active' : 'inactive') + '"><span class="status-dot ' + (i.status === 'active' ? 'connected' : '') + '"></span>' + escapeHtml(i.status) + '</span></div>';
                    }).join('') : '<div class="empty-state"><div class="empty-state-text">No integrations</div></div>';

                    document.getElementById('dashGrid').innerHTML =
                        '<div class="dashboard-card"><div class="card-title">Recent Activity</div><div class="activity-list">' + activityHtml + '</div></div>' +
                        '<div class="dashboard-card"><div class="card-title">Integrations</div><div class="integration-list">' + integrationsHtml + '</div></div>';
                });
            });
        }

        function getActivityIcon(type) {
            var icons = { content: '&#128221;', idea: '&#128161;', project: '&#128193;', ai: '&#129302;', sync: '&#128260;' };
            return icons[type] || '&#128204;';
        }

        // Content Kanban
        function renderContent() {
            api('/content/kanban', {}, function(err, kanban) {
                kanban = kanban || {};
                var columns = ['idea', 'draft', 'review', 'approved', 'posted'];
                var html = '<div class="kanban-board">';

                for (var i = 0; i < columns.length; i++) {
                    var col = columns[i];
                    var cards = kanban[col] || [];
                    html += '<div class="kanban-column" data-status="' + col + '">';
                    html += '<div class="kanban-header"><span class="kanban-title">' + col.charAt(0).toUpperCase() + col.slice(1) + '</span><span class="kanban-count">' + cards.length + '</span></div>';
                    html += '<div class="kanban-cards" data-status="' + col + '">';

                    for (var j = 0; j < cards.length; j++) {
                        var card = cards[j];
                        html += '<div class="kanban-card" draggable="true" data-id="' + card.id + '">';
                        html += '<div class="kanban-card-title">' + escapeHtml(card.title || 'Untitled') + '</div>';
                        html += '<div class="kanban-card-meta"><span>' + escapeHtml(card.platform || '') + '</span><span>' + formatDate(card.updated_at) + '</span></div></div>';
                    }

                    html += '<button class="add-card-btn" data-status="' + col + '">+ Add Card</button>';
                    html += '</div></div>';
                }

                html += '</div>';
                document.getElementById('contentArea').innerHTML = html;
                setupKanban();
            });
        }

        function setupKanban() {
            var cards = document.querySelectorAll('.kanban-card');
            var columns = document.querySelectorAll('.kanban-cards');
            var addBtns = document.querySelectorAll('.add-card-btn');

            for (var i = 0; i < cards.length; i++) {
                cards[i].addEventListener('dragstart', function(e) {
                    this.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', this.dataset.id);
                });
                cards[i].addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });
                cards[i].addEventListener('click', function() {
                    editContent(this.dataset.id);
                });
            }

            for (var j = 0; j < columns.length; j++) {
                columns[j].addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('drag-over');
                });
                columns[j].addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });
                columns[j].addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    var id = e.dataTransfer.getData('text/plain');
                    var newStatus = this.dataset.status;
                    updateContentStatus(id, newStatus);
                });
            }

            for (var k = 0; k < addBtns.length; k++) {
                addBtns[k].addEventListener('click', function() {
                    showModal('content', this.dataset.status);
                });
            }
        }

        function updateContentStatus(id, status) {
            api('/content/' + id, { method: 'PATCH', body: { status: status } }, function(err) {
                if (err) {
                    toast('Failed to update', 'error');
                } else {
                    toast('Content updated', 'success');
                    renderContent();
                }
            });
        }

        function editContent(id) {
            app.editingId = id;
            toast('Editing content ' + id, 'info');
        }

        // Ideas
        function renderIdeas() {
            api('/ideas/', {}, function(err, ideas) {
                ideas = ideas || [];
                app.data.ideas = ideas;

                var html = '<div style="margin-bottom:16px;"><button class="btn btn-primary" id="addIdeaBtn">+ New Idea</button></div>';
                html += '<div class="ideas-list">';

                if (ideas.length) {
                    for (var i = 0; i < ideas.length; i++) {
                        var idea = ideas[i];
                        var priority = (idea.priority || 'maybe').toLowerCase();
                        html += '<div class="idea-card" data-id="' + idea.id + '">';
                        html += '<div class="idea-header"><span class="idea-title">' + escapeHtml(idea.title || 'Untitled') + '</span>';
                        html += '<span class="priority-badge ' + priority + '">' + escapeHtml(idea.priority || 'Maybe') + '</span></div>';
                        html += '<div class="idea-source">Source: ' + escapeHtml(idea.source || 'Manual') + '</div>';
                        if (idea.description) {
                            html += '<div class="idea-description">' + escapeHtml(idea.description.substring(0, 100)) + (idea.description.length > 100 ? '...' : '') + '</div>';
                        }
                        html += '</div>';
                    }
                } else {
                    html += '<div class="empty-state"><div class="empty-state-icon">&#128161;</div><div class="empty-state-text">No ideas yet</div></div>';
                }

                html += '</div>';
                document.getElementById('contentArea').innerHTML = html;

                document.getElementById('addIdeaBtn').addEventListener('click', function() {
                    showModal('idea');
                });

                var ideaCards = document.querySelectorAll('.idea-card');
                for (var j = 0; j < ideaCards.length; j++) {
                    ideaCards[j].addEventListener('click', function() {
                        selectIdea(parseInt(this.dataset.id));
                    });
                }
            });
        }

        function selectIdea(id) {
            var idea = null;
            for (var i = 0; i < app.data.ideas.length; i++) {
                if (app.data.ideas[i].id === id) {
                    idea = app.data.ideas[i];
                    break;
                }
            }
            if (idea) {
                var priority = (idea.priority || 'maybe').toLowerCase();
                showPanel('Idea Details',
                    '<h3 style="margin-bottom:12px;">' + escapeHtml(idea.title) + '</h3>' +
                    '<span class="priority-badge ' + priority + '">' + escapeHtml(idea.priority || 'Maybe') + '</span>' +
                    '<p style="color:var(--text-secondary);margin:16px 0;">' + escapeHtml(idea.description || 'No description') + '</p>' +
                    '<div style="font-size:12px;color:var(--text-secondary);">Source: ' + escapeHtml(idea.source || 'Manual') + '</div>'
                );
            }
        }

        // Projects
        function renderProjects() {
            api('/projects/', {}, function(err, projects) {
                projects = projects || [];
                app.data.projects = projects;

                var html = '<div style="margin-bottom:16px;"><button class="btn btn-primary" id="addProjectBtn">+ New Project</button></div>';
                html += '<div class="projects-grid">';

                if (projects.length) {
                    for (var i = 0; i < projects.length; i++) {
                        var p = projects[i];
                        var statusClass = (p.status || 'active').toLowerCase();
                        html += '<div class="project-card" data-id="' + p.id + '">';
                        html += '<div class="project-header"><span class="project-title">' + escapeHtml(p.name || 'Untitled') + '</span>';
                        html += '<span class="project-status ' + statusClass + '">' + escapeHtml(p.status || 'Active') + '</span></div>';
                        html += '<p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;">' + escapeHtml(p.description || '') + '</p>';
                        html += '<div class="project-progress"><div class="progress-bar"><div class="progress-fill" style="width:' + (p.progress || 0) + '%"></div></div>';
                        html += '<div class="progress-text">' + (p.progress || 0) + '% complete</div></div>';

                        if (p.tasks && p.tasks.length) {
                            html += '<div class="task-list">';
                            var tasksToShow = p.tasks.slice(0, 3);
                            for (var j = 0; j < tasksToShow.length; j++) {
                                var t = tasksToShow[j];
                                html += '<div class="task-item"><div class="task-checkbox ' + (t.done ? 'done' : '') + '"></div><span>' + escapeHtml(t.title || t.name || '') + '</span></div>';
                            }
                            html += '</div>';
                        }

                        html += '</div>';
                    }
                } else {
                    html += '<div class="empty-state"><div class="empty-state-icon">&#128193;</div><div class="empty-state-text">No projects yet</div></div>';
                }

                html += '</div>';
                document.getElementById('contentArea').innerHTML = html;

                document.getElementById('addProjectBtn').addEventListener('click', function() {
                    showModal('project');
                });

                var projectCards = document.querySelectorAll('.project-card');
                for (var k = 0; k < projectCards.length; k++) {
                    projectCards[k].addEventListener('click', function() {
                        toast('Project ' + this.dataset.id + ' selected', 'info');
                    });
                }
            });
        }

        // AI Module
        function renderAI() {
            var area = document.getElementById('contentArea');
            area.innerHTML = '<div class="ai-grid"><div class="chart-container"><div class="card-title">Daily AI Costs</div><canvas id="aiCostChart"></canvas></div><div class="chart-container"><div class="card-title">Usage by Model</div><canvas id="aiModelChart"></canvas></div></div><div class="ai-logs" id="aiLogs"><div class="ai-logs-header">Recent AI Calls</div><div class="ai-logs-list" id="aiLogsList"><div class="loading"><div class="spinner"></div></div></div></div>';

            api('/ai/logs', {}, function(err, logs) {
                logs = logs || [];
                var logsHtml = logs.length ? logs.slice(0, 20).map(function(log) {
                    return '<div class="ai-log-item"><div><span class="ai-log-model">' + escapeHtml(log.model || 'unknown') + '</span></div><div class="ai-log-prompt">' + escapeHtml(log.prompt || log.request || '') + '</div><div class="ai-log-meta"><span>Tokens: ' + (log.tokens || ((log.input_tokens || 0) + (log.output_tokens || 0))) + '</span><span>Cost: $' + (log.cost || 0).toFixed(4) + '</span><span>' + formatTime(log.timestamp || log.created_at) + '</span></div></div>';
                }).join('') : '<div class="empty-state"><div class="empty-state-text">No AI calls logged</div></div>';

                document.getElementById('aiLogsList').innerHTML = logsHtml;
            });

            api('/ai/costs', {}, function(err, costs) {
                costs = costs || { daily: [], by_model: {} };
                renderAICostChart(costs.daily || []);
                renderAIModelChart(costs.by_model || {});
            });
        }

        function renderAICostChart(data) {
            var ctx = document.getElementById('aiCostChart');
            if (!ctx) return;

            if (app.charts.aiCost) app.charts.aiCost.destroy();

            app.charts.aiCost = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(function(d) { return d.date || ''; }),
                    datasets: [{
                        label: 'Cost ($)',
                        data: data.map(function(d) { return d.cost || 0; }),
                        borderColor: '#58a6ff',
                        backgroundColor: 'rgba(88, 166, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } },
                        y: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } }
                    }
                }
            });
        }

        function renderAIModelChart(data) {
            var ctx = document.getElementById('aiModelChart');
            if (!ctx) return;

            if (app.charts.aiModel) app.charts.aiModel.destroy();

            var labels = Object.keys(data);
            var values = [];
            for (var i = 0; i < labels.length; i++) {
                values.push(data[labels[i]]);
            }

            if (labels.length === 0) {
                labels = ['No data'];
                values = [1];
            }

            app.charts.aiModel = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#58a6ff', '#3fb950', '#d29922', '#a371f7', '#f85149']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#c9d1d9' } }
                    }
                }
            });
        }

        // Performance
        function renderPerformance() {
            var area = document.getElementById('contentArea');
            area.innerHTML = '<div class="perf-stats" id="perfStats"></div><div class="ai-grid"><div class="chart-container"><div class="card-title">Grade Distribution</div><canvas id="gradeChart"></canvas></div><div class="chart-container"><div class="card-title">Performance Over Time</div><canvas id="perfTimeChart"></canvas></div></div><div class="perf-logs" style="margin-top:20px;" id="perfLogs"><div class="perf-logs-header">Recent Posts</div><div id="perfLogsList"><div class="loading"><div class="spinner"></div></div></div></div>';

            api('/performance/stats', {}, function(err, stats) {
                stats = stats || {};
                document.getElementById('perfStats').innerHTML =
                    '<div class="perf-stat"><div class="perf-stat-value">' + (stats.total_posts || 0) + '</div><div class="perf-stat-label">Total Posts</div></div>' +
                    '<div class="perf-stat"><div class="perf-stat-value">' + (stats.avg_score ? stats.avg_score.toFixed(1) : '0') + '</div><div class="perf-stat-label">Avg Score</div></div>' +
                    '<div class="perf-stat"><div class="perf-stat-value">' + (stats.a_grade_pct ? stats.a_grade_pct.toFixed(0) : '0') + '%</div><div class="perf-stat-label">A Grades</div></div>' +
                    '<div class="perf-stat"><div class="perf-stat-value">' + formatNumber(stats.total_engagement || 0) + '</div><div class="perf-stat-label">Total Engagement</div></div>';

                renderGradeChart(stats.grade_distribution || {});
            });

            api('/performance/', {}, function(err, logs) {
                logs = logs || [];
                var logsHtml = logs.length ? logs.slice(0, 15).map(function(log) {
                    var grade = (log.grade || 'c').toLowerCase();
                    return '<div class="perf-log-item"><div><div style="font-weight:500;">' + escapeHtml(log.title || 'Untitled') + '</div><div style="font-size:12px;color:var(--text-secondary);">' + escapeHtml(log.platform || '') + ' - ' + formatDate(log.posted_at) + '</div></div><span class="perf-grade ' + grade + '">' + escapeHtml(log.grade || 'C') + '</span></div>';
                }).join('') : '<div class="empty-state"><div class="empty-state-text">No performance data</div></div>';

                document.getElementById('perfLogsList').innerHTML = logsHtml;
                renderPerfTimeChart(logs);
            });
        }

        function renderGradeChart(data) {
            var ctx = document.getElementById('gradeChart');
            if (!ctx) return;

            if (app.charts.grade) app.charts.grade.destroy();

            app.charts.grade = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['A', 'B', 'C', 'D', 'F'],
                    datasets: [{
                        data: [data.A || 0, data.B || 0, data.C || 0, data.D || 0, data.F || 0],
                        backgroundColor: ['#3fb950', '#7ee787', '#d29922', '#ffa657', '#f85149']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#8b949e' } },
                        y: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } }
                    }
                }
            });
        }

        function renderPerfTimeChart(logs) {
            var ctx = document.getElementById('perfTimeChart');
            if (!ctx) return;

            if (app.charts.perfTime) app.charts.perfTime.destroy();

            var recentLogs = logs.slice(0, 30).reverse();

            app.charts.perfTime = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: recentLogs.map(function(l) { return formatDate(l.posted_at); }),
                    datasets: [{
                        label: 'Score',
                        data: recentLogs.map(function(l) { return l.score || 0; }),
                        borderColor: '#58a6ff',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } }
                    }
                }
            });
        }

        // Memory
        function renderMemory() {
            api('/memory/', {}, function(err, memories) {
                memories = memories || [];
                app.data.memories = memories;

                var memoryListHtml = memories.length ? memories.map(function(m, i) {
                    return '<div class="memory-item ' + (i === 0 ? 'active' : '') + '" data-id="' + m.id + '"><div class="memory-date">' + formatDate(m.date || m.created_at) + '</div><div class="memory-preview">' + escapeHtml((m.content || '').substring(0, 50)) + '</div></div>';
                }).join('') : '<div class="empty-state"><div class="empty-state-text">No memories</div></div>';

                var firstMemory = memories[0];
                var viewerContent = firstMemory ? escapeHtml(firstMemory.content || 'Select a memory to view') : 'Select a memory to view';
                var viewerTitle = firstMemory ? formatDate(firstMemory.date || firstMemory.created_at) : 'Memory';

                document.getElementById('contentArea').innerHTML =
                    '<div class="memory-layout">' +
                    '<div class="memory-sidebar">' +
                    '<div class="memory-tabs"><div class="memory-tab active" data-type="daily">Daily Notes</div><div class="memory-tab" data-type="longterm">Long-term</div></div>' +
                    '<div class="memory-search"><input type="text" placeholder="Search memories..." id="memorySearch"></div>' +
                    '<div class="memory-list" id="memoryList">' + memoryListHtml + '</div></div>' +
                    '<div class="memory-viewer"><div class="card-title" id="memoryTitle">' + viewerTitle + '</div><div class="memory-content" id="memoryContent">' + viewerContent + '</div></div></div>';

                document.getElementById('memorySearch').addEventListener('input', function() {
                    filterMemories(this.value);
                });

                var memoryItems = document.querySelectorAll('.memory-item');
                for (var i = 0; i < memoryItems.length; i++) {
                    memoryItems[i].addEventListener('click', function() {
                        selectMemory(parseInt(this.dataset.id));
                    });
                }

                var memoryTabs = document.querySelectorAll('.memory-tab');
                for (var j = 0; j < memoryTabs.length; j++) {
                    memoryTabs[j].addEventListener('click', function() {
                        for (var k = 0; k < memoryTabs.length; k++) {
                            memoryTabs[k].classList.remove('active');
                        }
                        this.classList.add('active');
                        toast('Viewing ' + this.dataset.type + ' memories', 'info');
                    });
                }
            });
        }

        function selectMemory(id) {
            var memory = null;
            for (var i = 0; i < app.data.memories.length; i++) {
                if (app.data.memories[i].id === id) {
                    memory = app.data.memories[i];
                    break;
                }
            }
            if (memory) {
                var items = document.querySelectorAll('.memory-item');
                for (var j = 0; j < items.length; j++) {
                    items[j].classList.remove('active');
                    if (parseInt(items[j].dataset.id) === id) {
                        items[j].classList.add('active');
                    }
                }
                document.getElementById('memoryTitle').textContent = formatDate(memory.date || memory.created_at);
                document.getElementById('memoryContent').textContent = memory.content || '';
            }
        }

        function filterMemories(query) {
            var items = document.querySelectorAll('.memory-item');
            var q = query.toLowerCase();
            for (var i = 0; i < items.length; i++) {
                var text = items[i].textContent.toLowerCase();
                items[i].style.display = text.indexOf(q) >= 0 ? '' : 'none';
            }
        }

        // Modals
        function showModal(type, extra) {
            extra = extra || '';
            var overlay = document.getElementById('modalOverlay');
            var title = document.getElementById('modalTitle');
            var body = document.getElementById('modalBody');
            var submit = document.getElementById('modalSubmit');

            app.editingId = null;

            if (type === 'content') {
                title.textContent = 'Create Content';
                body.innerHTML =
                    '<div class="form-group"><label class="form-label">Title</label><input type="text" class="form-input" id="contentTitle" placeholder="Content title"></div>' +
                    '<div class="form-group"><label class="form-label">Platform</label><select class="form-select" id="contentPlatform"><option value="linkedin">LinkedIn</option><option value="twitter">Twitter</option><option value="blog">Blog</option><option value="newsletter">Newsletter</option></select></div>' +
                    '<div class="form-group"><label class="form-label">Status</label><select class="form-select" id="contentStatus"><option value="idea"' + (extra === 'idea' ? ' selected' : '') + '>Idea</option><option value="draft"' + (extra === 'draft' ? ' selected' : '') + '>Draft</option><option value="review"' + (extra === 'review' ? ' selected' : '') + '>Review</option><option value="approved"' + (extra === 'approved' ? ' selected' : '') + '>Approved</option></select></div>' +
                    '<div class="form-group"><label class="form-label">Content</label><textarea class="form-textarea" id="contentBody" placeholder="Write your content..."></textarea></div>';
                submit.onclick = saveContent;
            } else if (type === 'idea') {
                title.textContent = 'Create Idea';
                body.innerHTML =
                    '<div class="form-group"><label class="form-label">Title</label><input type="text" class="form-input" id="ideaTitle" placeholder="Idea title"></div>' +
                    '<div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="ideaDesc" placeholder="Describe the idea..."></textarea></div>' +
                    '<div class="form-group"><label class="form-label">Priority</label><select class="form-select" id="ideaPriority"><option value="Hot">Hot</option><option value="Save">Save</option><option value="Maybe">Maybe</option></select></div>' +
                    '<div class="form-group"><label class="form-label">Source</label><input type="text" class="form-input" id="ideaSource" placeholder="Where did this idea come from?"></div>';
                submit.onclick = saveIdea;
            } else if (type === 'project') {
                title.textContent = 'Create Project';
                body.innerHTML =
                    '<div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="projectName" placeholder="Project name"></div>' +
                    '<div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="projectDesc" placeholder="Project description..."></textarea></div>' +
                    '<div class="form-group"><label class="form-label">Status</label><select class="form-select" id="projectStatus"><option value="active">Active</option><option value="paused">Paused</option><option value="completed">Completed</option></select></div>';
                submit.onclick = saveProject;
            }

            overlay.classList.add('active');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        function saveContent() {
            var data = {
                title: document.getElementById('contentTitle').value,
                platform: document.getElementById('contentPlatform').value,
                status: document.getElementById('contentStatus').value,
                body: document.getElementById('contentBody').value
            };

            api('/content/', { method: 'POST', body: data }, function(err) {
                if (err) {
                    toast('Failed to create content', 'error');
                } else {
                    closeModal();
                    toast('Content created', 'success');
                    if (app.currentTab === 'content') renderContent();
                }
            });
        }

        function saveIdea() {
            var data = {
                title: document.getElementById('ideaTitle').value,
                description: document.getElementById('ideaDesc').value,
                priority: document.getElementById('ideaPriority').value,
                source: document.getElementById('ideaSource').value
            };

            api('/ideas/', { method: 'POST', body: data }, function(err) {
                if (err) {
                    toast('Failed to create idea', 'error');
                } else {
                    closeModal();
                    toast('Idea created', 'success');
                    if (app.currentTab === 'ideas') renderIdeas();
                }
            });
        }

        function saveProject() {
            var data = {
                name: document.getElementById('projectName').value,
                description: document.getElementById('projectDesc').value,
                status: document.getElementById('projectStatus').value
            };

            api('/projects/', { method: 'POST', body: data }, function(err) {
                if (err) {
                    toast('Failed to create project', 'error');
                } else {
                    closeModal();
                    toast('Project created', 'success');
                    if (app.currentTab === 'projects') renderProjects();
                }
            });
        }

        // Panel
        function showPanel(title, content) {
            document.getElementById('panelTitle').textContent = title;
            document.getElementById('panelContent').innerHTML = content;
        }

        function closePanel() {
            document.getElementById('panelContent').innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#128203;</div><div class="empty-state-text">Select an item to view details</div></div>';
            document.getElementById('panelTitle').textContent = 'Details';
        }

        // Sync
        function triggerSync() {
            var btn = document.getElementById('syncBtn');
            btn.disabled = true;
            btn.textContent = 'Syncing...';

            api('/sync/airtable', { method: 'POST' }, function(err) {
                if (err) {
                    toast('Sync failed', 'error');
                    btn.disabled = false;
                    btn.textContent = 'Sync';
                } else {
                    toast('Sync started', 'info');
                }
            });
        }

        // Utilities
        function escapeHtml(str) {
            if (!str) return '';
            var div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML;
        }

        function escapeAttr(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function formatDate(date) {
            if (!date) return '';
            try {
                return new Date(date).toLocaleDateString();
            } catch(e) {
                return '';
            }
        }

        function formatTime(date) {
            if (!date) return '';
            try {
                var d = new Date(date);
                var now = new Date();
                var diff = now - d;

                if (diff < 60000) return 'Just now';
                if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
                if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
                return d.toLocaleDateString();
            } catch(e) {
                return '';
            }
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return String(num);
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
    </script>
</body>
</html>
